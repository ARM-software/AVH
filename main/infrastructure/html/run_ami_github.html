<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Run AMI with GitHub Actions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td style="padding: 1em;"id="projectlogo"><img alt="Logo" src="arm.png"/></td>
  <td style="padding-left: 2em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">Virtual Hardware
   &#160;<span id="projectnumber">Version 0.2 - beta</span>
   </div>
   <div id="projectbrief">Infrastructure Service and Tool Integration</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="Compnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('run_ami_github.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Run AMI with GitHub Actions </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_src_github"></a> GitHub Actions help you automate tasks within your software development life cycle. GitHub Actions are event-driven, meaning that you can run a series of commands after a specified event has occurred. For example, every time someone commits a push or creates a pull request for a repository, you can automatically run the Arm VHT Services that execute automated build or test scripts. Refer to <a href="https://docs.github.com/en/actions/learn-github-actions/introduction-to-github-actions">Introduction to GitHub Actions</a> for information about the components of GitHub Actions.</p>
<p >There are several different ways to execute GitHub Actions:</p><ul>
<li><a href="./#self_hosted"><b>Self-hosted GitHub runners</b></a> where the complete GitHub Action is executed on an AWS EC2 Linux instance.</li>
<li><a href="./#GitHub_hosted"><b>GitHub-hosted runners</b></a> where only a part of the GitHub Action (for example testing) is executed on an AWS EC2 Linux instance.</li>
</ul>
<p >The approach that you should choose depends on your CI/CD requirements.</p>
<h1><a class="anchor" id="self_hosted"></a>
Self-hosted GitHub Runners</h1>
<p >The following steps explain how to use <b>self-hosted GitHub runners</b> with <a href="https://aws.amazon.com/marketplace/search/results?searchTerms=Arm+Virtual+Hardware">AWS Marketplace: Arm Virtual Hardware</a>.</p>
<ol type="1">
<li><a href="#self-hosted1"><b>Configure GitHub Actions</b></a> and obtain the <em>download</em> and <em>configuration</em> scripts.</li>
<li><a href="#self-hosted2"><b>Start AMI Console</b></a> and copy the <em>download</em> and <em>configuration</em> scripts.</li>
<li><a href="#self-hosted3"><b>Setup runner on AMI</b></a> to your GitHub repository and configure it for your requirements.</li>
<li><a href="#test_action"><b>Test GitHub Action</b></a> to verify that it performs as expected.</li>
</ol>
<p >Once this steps are completed, any commit or pull request to the repository should trigger the <em>CI</em> workflow that you have defined.</p>
<h2><a class="anchor" id="setup_AWS"></a>
Setup AWS EC2 Instance</h2>
<ul>
<li>Subscribe to the <a href="https://aws.amazon.com/marketplace/search/results?searchTerms=Arm+Virtual+Hardware">AWS Marketplace: Arm Virtual Hardware</a></li>
<li>What are the steps to configure/setup the Arm Virtual Hardware?</li>
</ul>
<h2><a class="anchor" id="add_secrets"></a>
Add GitHub Secrets</h2>
<ul>
<li>What/how to setup secrets?</li>
</ul>
<h2><a class="anchor" id="add_action"></a>
Add GitHub Action</h2>
<ul>
<li>How is the EC2 instance started/stopped? What effect to charging has this?</li>
<li>What are the steps to add the GitHub action?</li>
</ul>
<div class="fragment"><div class="line"># This is a sample workflow for projects that use CMSIS-Build</div>
<div class="line"> </div>
<div class="line">name: Arm Virtual Hardware example</div>
<div class="line"> </div>
<div class="line">on:</div>
<div class="line">  push:</div>
<div class="line">    branches: [ main ]</div>
<div class="line">  pull_request:</div>
<div class="line">    branches: [ main ]</div>
<div class="line"> </div>
<div class="line"># To allow you to run this workflow manually from the GitHub Actions tab add</div>
<div class="line">  workflow_dispatch:</div>
<div class="line"> </div>
<div class="line">jobs:</div>
<div class="line">  ci_demonstration:</div>
<div class="line">    runs-on: self-hosted</div>
<div class="line">    env:</div>
<div class="line">      working-directory: ${{ github.workspace }}/Platform_FVP_Corstone_SSE-300_Ethos-U55/</div>
<div class="line">    steps:</div>
<div class="line">      - name: Check out repository code</div>
<div class="line">        uses: actions/checkout@v2</div>
<div class="line"> </div>
<div class="line">      - name: What has been cloned?</div>
<div class="line">        run: echo &quot;${{ github.repository }} has been cloned.&quot;</div>
<div class="line"> </div>
<div class="line">      - name: Get dependencies</div>
<div class="line">        run: cp_install.sh packlist</div>
<div class="line">        working-directory: ${{env.working-directory}}</div>
<div class="line"> </div>
<div class="line">      - name: Build the micro_speech example</div>
<div class="line">        run: cbuild.sh microspeech.Example.cprj</div>
<div class="line">        working-directory: ${{env.working-directory}}</div>
<div class="line"> </div>
<div class="line">      - name: Run the micro_speech example</div>
<div class="line">        run: ./run_example.sh</div>
<div class="line">        working-directory: ${{env.working-directory}}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Test GitHub Action</h2>
<p >Once this GitHub action is deployed, it may be manually tested.</p>
<p >Describe the steps, i.e to start <a href="https://github.com/MDK-Packs/VHT-TFLmicrospeech/actions">https://github.com/MDK-Packs/VHT-TFLmicrospeech/actions</a></p>
<h1><a class="anchor" id="GitHub_hosted"></a>
GitHub-hosted Runners</h1>
<p >The following steps explain how to use <b>GitHub-hosted runners</b> with <a href="https://aws.amazon.com/marketplace/pp/prodview-urbpq7yo5va7g">AWS Marketplace: Arm Virtual Hardware</a>.</p>
<ol type="1">
<li><a href="#setup_AWS"><b>Setup AWS EC2 Instance</b></a> and obtain the <em>access information</em>.</li>
<li><a href="#add_secrets"><b>Add GitHub Secrets</b></a> with the <em>access information</em> to your GitHub repository with gives access to the AWS EC2 instance.</li>
<li><a href="#add_action"><b>Add GitHub Action</b></a> to your GitHub repository and configure it for your requirements.</li>
<li><a href="#test_action"><b>Test GitHub Action</b></a> to verify that it performs as expected.</li>
</ol>
<p >Once this steps are completed, any commit or pull request to the repository should trigger the <em>CI</em> workflow that you have defined.</p>
<p >An <a class="el" href="index.html#AWS">Amazon Machine Image (AMI)</a> provides a complete tool installation that can be integrated with GitHub Actions. To simplify integration the <a href="https://github.com/ARM-software/VHT-AMI">Arm Arm Virtual Hardware - GitHub Action</a> can be integrated into GitHub jobs. This action manages connection, upload and execution of a test suite on Amazon EC2 Linux instance that runs an <a class="el" href="index.html#AWS">Arm VHT AMI</a>.</p>
<p ><img src="vht_action.png" alt="" class="inline" title="VHT GitHub action"/></p>
<p >The VHT-AMI action receives a *.tar input file (vht_in) that contains the vht.yml control file. The vht.yml is the run control commands for the AMI and defines the execution of build scripts or test runs. Once the AMI run control commands are complete the results are returned as *.tar file to the GitHub runner.</p>
<p >The file <a href="https://github.com/ARM-software/VHT-AMI/blob/master/action.yml">action.yml</a> defines the parameters for the GitHub action.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
AWS Account Setup</h2>
<p >The following AWS account requirements are needed to run VHT-AMI action.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Create PassRole policy for VHT-AMI</h3>
<p >You need to create a PassRole IAM policy to be attached to our IAM User with the following content. You can name it <code>vht-passrole</code>. </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</div>
<div class="line">    &quot;Statement&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">            &quot;Action&quot;: &quot;iam:PassRole&quot;,</div>
<div class="line">            &quot;Resource&quot;: &quot;*&quot;</div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><p >More info: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create-console.html">Create IAM Policy</a></p>
<h3><a class="anchor" id="autotoc_md11"></a>
Create Identity and Access Management (IAM) User</h3>
<p >You have to create an IAM User to limit resource permission to your CI. In addition, the IAM User provides fixed <code>AWS Access Key Id</code> and <code>AWS Secret access key</code> values. For this user, you have to add the following <code>policies</code>:</p><ul>
<li>vht-passrole (created before)</li>
<li>AmazonEC2FullAccess (AWS managed policy --&gt; It already exists in your account)</li>
<li>AmazonS3FullAccess (AWS managed policy --&gt; It already exists in your account)</li>
<li>AmazonSSMFullAccess (AWS managed policy --&gt; It already exists in your account)</li>
</ul>
<p >You also need to add the following <code>Permission boundary</code>:</p><ul>
<li>PowerUserAccess</li>
</ul>
<p >The user can be called <code>vht</code>.</p>
<p >More info: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html">Create IAM User</a></p>
<h3><a class="anchor" id="autotoc_md12"></a>
Create an IAM Role For EC2 Services</h3>
<p >You have to create IAM Role to be attached to the EC2 Instances. This role gives EC2 Instances access to S3 buckets and SSM services. For this role, you have to add the following <code>policies</code>:</p><ul>
<li>AmazonS3FullAccess</li>
<li>AmazonSSMFullAccess</li>
</ul>
<p >You also need to add the following <code>Permission boundary</code>:</p><ul>
<li>PowerUserAccess</li>
</ul>
<p >More info: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html">Create IAM Role For Service</a></p>
<h2><a class="anchor" id="autotoc_md13"></a>
Usage</h2>
<p >You can now consume the action by referencing the v1 branch</p>
<div class="fragment"><div class="line">uses: Arm-Software/VHT-AMI@v1</div>
<div class="line">with:</div>
<div class="line">  vht_in:</div>
<div class="line">  instance_id: ${{ secrets.AWS_INSTANCE_ID }}</div>
<div class="line">  access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}</div>
<div class="line">  secret_key_id: ${{ secrets.AWS_SECRET_KEY }}</div>
<div class="line">  aws_region: &quot;eu-west-1&quot;</div>
<div class="line">  s3_bucket_name: my_bucket</div>
</div><!-- fragment --><p ><b>Where</b></p>
<ul>
<li><em>secrets.AWS_INSTANCE_ID</em> is the instance ID of the AMI stored as GitHub secret.</li>
<li><em>secrets.AWS_ACCESS_KEY_ID</em> is the access key to AMI stored as GitHub secret.</li>
<li><em>secrets.AWS_SECRET_KEY</em> is the secret key to AMI stored as GitHub secret.</li>
<li>aws_region: name of the region your EC2 and S3 instances are located</li>
<li>s3_bucket_name: for temporary storage an S3 bucket is used</li>
</ul>
<p >Refer to <a href="https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository">Creating encrypted secrets for a repository</a> for storing the AMI access information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
	Copyright &copy; 2021 Arm Limited (or its affiliates). All rights reserved.
	<!-- Use script below for auto-inserting date, project name, version, etc  -->
	<!-- <script type="text/javascript">
        writeFooter.call(this);
    </script> -->
    </li>
  </ul>
</div>
</body>
</html>

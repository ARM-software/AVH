<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Examples: AWS MQTT Example</title>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeInteractiveToc.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow" style="height: 55px;">
  <td id="projectlogo" style="padding: 1em;"><img alt="Logo" src="arm.png"/></td>
  <td style="padding-left: 2em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">Virtual Hardware
   &#160;<span id="projectnumber">Version 1.3.1 - beta</span>
   </div>
   <div id="projectbrief">Examples Projects and GitHub Repositories</div>
  </td>
  <!--END !PROJECT_NAME-->
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="Compnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('aws_mqtt.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">AWS MQTT Example </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_src_aws_mqtt"></a></p>
<p>This example is based on <a href="https://docs.aws.amazon.com/freertos/latest/userguide/mqtt-demo-ma.html">AWS coreMQTT mutual authentication demo</a> and demonstrates how to use cloud-connectivity on Arm Virtual Hardware (AVH) via <a href="../../simulation/html/group__arm__vsocket.html">VSocket interface</a>, and how to verify such communication with Continuous Integration (CI) workflows. The project is maintained in the GitHub repository <a href="https://github.com/ARM-software/AVH-AWS_MQTT_Demo"><b>github.com/ARM-software/AVH-AWS_MQTT_Demo</b></a> that also contains additional description of the example.</p>
<h1><a class="anchor" id="aws_mqtt_overview"></a>
Overview</h1>
<p>The AWS MQTT Example application connects to <a href="https://docs.aws.amazon.com/en_en/iot/latest/developerguide/mqtt.html">AWS MQTT broker</a> using TLS with mutual authentication between the client and the server. As a network interface either Ethernet or WiFi can be used on hardware boards, or VSocket on Arm FVP models. The application subscribes to MQTT topics and publishes messages that can be observed in AWS IoT MQTT client.</p>
<p>Automated test execution is managed with GitHub Actions and gets triggered on every code change in the repository. The program gets built and run on <a href="https://www.arm.com/products/development-tools/simulation/virtual-hardware">Arm Virtual Hardware</a> cloud infrastructure in AWS and the test results can be then observed in repository's <a href="https://github.com/ARM-software/AVH-GetStarted/actions">GitHub Actions</a>.</p>
<h1><a class="anchor" id="aws_mqtt_prerequisites"></a>
Prerequisites</h1>
<p>Following is required to reproduce operation of the example project:</p>
<ul>
<li>a <a href="https://github.com/">GitHub</a> account</li>
<li>an <a href="https://aws.amazon.com/">AWS</a> account with <a href="../../infrastructure/html/AWS.html#Subscribe">subscribtion to Arm Virtual Hardware</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md23"></a>
Device commissioning</h1>
<p>In order to communicate with the AWS IoT service the embedded application needs to be commissioned with proper connection and security parameters that match the configuration in the cloud service. <a class="el" href="aws_mqtt.html#aws_iot_thing">Create AWS IoT Thing</a> describes how to setup necessary endpoint in the AWS and <a class="el" href="aws_mqtt.html#aws_iot_params">Commission parameters to device</a> explains how to apply the parameters in the embedded code.</p>
<h2><a class="anchor" id="aws_iot_thing"></a>
Create AWS IoT Thing</h2>
<p>The communication and security parameters can be obtained from <a href="https://aws.amazon.com/iot-core/">AWS IoT Core</a> service. Steps below explain the process for this example and AWS tutorial <a href="https://docs.aws.amazon.com/iot/latest/developerguide/create-iot-resources.html">Create AWS IoT</a> provides general overview and additional references.</p>
<p>Create an AWS <b>IoT Thing</b> for your device as follows:</p>
<ul>
<li>From your AWS Management Console browse to the <b>AWS IoT Core</b> service.</li>
<li>In the left navigation pane, choose <b>Manage</b>, and then choose <b>Things</b>.</li>
<li>On the Things page click <b>Create things</b> button, choose <b>Create a single thing</b> and proceed further.</li>
<li>In the thing properties provide a name for your thing (for example <em>MyThing</em>), keep other parameters at default and then choose <b>Next</b>. Later you will need to provision the same name to the embedded code.</li>
<li>Choose to Auto-generate a certificate for your thing.</li>
<li>When offered to attach policies to certificate, click <b>Create policy</b> to open corresponding page in a separate browser tab. There:<ul>
<li>Enter a name for the policy (for example “MyThingPolicy”).</li>
<li>In the <b>Policy document</b> area add new statements, each with <b>Policy effect</b> set to <b>Allow</b> and following values in <b>Policy action</b> respectively:<ul>
<li><b>iot:Connect</b></li>
<li><b>iot:Publish</b></li>
<li><b>iot:Subscribe</b></li>
<li><b>iot:Receive</b></li>
</ul>
</li>
<li>In the <b>Policy resource</b> set * for all statements.</li>
<li>Click on <b>Create</b> and observe the new policy appeared in the list.</li>
</ul>
</li>
<li>Return to the browser tab where offered to attach policies to certifate and observe the created. There:<ul>
<li>Select the policy to be attached to the certificate.</li>
<li>Click <b>Create thing</b>.</li>
<li>Download the certicate, public and private keys by choosing the <b>Download</b> links for each.</li>
</ul>
</li>
<li>Make a note of your Device data endpoint.<ul>
<li>In the navigation pane of the AWS IoT console, choose <b>Settings</b> and there find the <b>Device data endpoint</b> such as <em>a3xyzzyx.iot.us-east-2.amazonaws.com</em> to have it ready for later.</li>
</ul>
</li>
</ul>
<p>Now you have all information required for connecting your device to the AWS IoT Cloud.</p>
<h2><a class="anchor" id="aws_iot_params"></a>
Commission parameters to device</h2>
<p>In the example code the required commissioning parameters are defined in the following files:</p>
<ul>
<li><a href="https://github.com/ARM-software/AVH-AWS_MQTT_Demo/blob/main/amazon-freertos/demos/include/aws_clientcredential.h"><code>aws_clientcredential.h</code></a></li>
<li><a href="https://github.com/ARM-software/AVH-AWS_MQTT_Demo/blob/main/amazon-freertos/demos/include/aws_clientcredential_keys.h"><code>aws_clientcredential_keys.h</code></a></li>
</ul>
<p>Note: when the project is imported to uVision these files are present in the <code>demos_include</code> group.</p>
<p>Specifically following definitions need to be updated:</p><ul>
<li><code>clientcredentialMQTT_BROKER_ENDPOINT</code>: Device data endpoint<ul>
<li>Take the value in AWS IoT Console under <b>Settings</b>, it appears in format such as a3xyzzyx.iot.us-east-2.amazonaws.com.</li>
</ul>
</li>
<li><code>clientcredentialIOT_THING_NAME</code>: Thing Name<ul>
<li>Use the name specified in <a class="el" href="aws_mqtt.html#aws_iot_thing">Create AWS IoT Thing</a></li>
</ul>
</li>
<li><code>keyCLIENT_CERTIFICATE_PEM</code>: Client Security Certificate<ul>
<li>Provide here the value from the device certificate file (**.perm.crt*) associated with the AWS Thing named above.</li>
</ul>
</li>
<li><code>keyCLIENT_PRIVATE_KEY_PEM</code>: Client Private Key<ul>
<li>Provide here the value from the private key file of the certificate associated with the AWS Thing named above.</li>
</ul>
</li>
<li><code>clientcredentialWIFI_SSID</code>: WiFi Access Point SSID (when connecting via WiFi, can be empty otherwise).</li>
<li><code>clientcredentialWIFI_PASSWORD</code>: WiFi Access Point Password (when connecting via WiFi, can be empty otherwise).</li>
</ul>
<p>Note that when running the example on Arm Virtual Hardware using GitHub Actions, corresponding definitions (non-WiFi) are automatically updated in the code with values stored in <a class="el" href="aws_mqtt.html#aws_mqtt_gh_secrets">GitHub Secrets</a>.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Setup of CI Test</h1>
<p>To build and run this application program with a GitHub Actions workflow the following steps are required. For details refer to <a href="https://arm-software.github.io/AVH/main/infrastructure/html/run_ami_github.html">Run AMI with GitHub Actions</a>.</p>
<ol type="1">
<li><b>Amazon Web Service (AWS) account</b> with:<ul>
<li>Amazon EC2 (elastic cloud) access</li>
<li>Amazon S3 (storage) access</li>
<li>Registration to access AVH Amazon Machine Image <a href="https://aws.amazon.com/marketplace/search/results?searchTerms=Arm+Virtual+Hardware">AVH AMI</a></li>
<li>User role setup for scripted API access</li>
</ul>
</li>
<li><b>GitHub</b>:<ul>
<li>Fork this repository with at least <em>Write</em> access rights</li>
<li>Store the AWS account configuration (obtained in step 1) as values of <a class="el" href="aws_mqtt.html#aws_mqtt_gh_secrets">AWS Access GitHub Secrets</a> in the forked repository.</li>
<li>Store the commissioning parameters (obtained in <a class="el" href="aws_mqtt.html#aws_iot_thing">Create AWS IoT Thing</a>) as values of <a class="el" href="aws_mqtt.html#aws_mqtt_gh_secrets">IoT Cloud Access GitHub Secrets</a> in the forked repository.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="aws_mqtt_gh_secrets"></a>
GitHub Secrets</h2>
<p>The following (secret) configuration values need to be added to the repositories as <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">GitHub Secrets</a>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Secret Name   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>AWS Access</b>   </td><td class="markdownTableBodyLeft"><b>Settings and credentials required to acces AWS EC2 and S3 services</b>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>AWS_IAM_PROFILE</code>   </td><td class="markdownTableBodyLeft">The <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html">IAM Role</a> to be used for AWS access.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>AWS_ACCESS_KEY_ID</code><br  />
<code>AWS_SECRET_ACCESS_KEY</code>   </td><td class="markdownTableBodyLeft"><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html">Access key pair</a> for the AWS account (as IAM user) that shall be used by the CI workflow for AWS access.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>AWS_S3_BUCKET_NAME</code>   </td><td class="markdownTableBodyLeft">The name of the S3 storage bucket to be used for data exchange between GitHub and AWS AMI.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>AWS_DEFAULT_REGION</code>   </td><td class="markdownTableBodyLeft">The data center region the AVH AMI will be run on. For example <code>eu-west-1</code>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>AWS_SECURITY_GROUP_ID</code>   </td><td class="markdownTableBodyLeft">The id of the <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">VPC security group</a> to add the EC2 instance to. Shall have format <code>sg-xxxxxxxx</code>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>AWS_SUBNET_ID</code>   </td><td class="markdownTableBodyLeft">The id of the <a href="https://docs.aws.amazon.com/vpc/latest/userguide/working-with-vpcs.html#view-subnet">VPC subnet</a> to connect the EC2 instance to. Shall have format <code>subnet-xxxxxxxx</code>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>IoT Cloud Access</b>   </td><td class="markdownTableBodyLeft"><b>Settings and credentials required to connect an <a href="https://github.com/MDK-Packs/Documentation/tree/master/AWS_Thing">AWS IoT Thing</a></b>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>CLIENT_CERTIFICATE_PEM</code>   </td><td class="markdownTableBodyLeft">Client (device) certificate    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>CLIENT_PRIVATE_KEY_PEM</code>   </td><td class="markdownTableBodyLeft">Client (device) private key    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>IOT_THING_NAME</code>   </td><td class="markdownTableBodyLeft">Client (device) name    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>MQTT_BROKER_ENDPOINT</code>   </td><td class="markdownTableBodyLeft">MQTT broker host name   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
	Copyright &copy; 2021-2023 Arm Limited (or its affiliates). All rights reserved.
	<!-- Use script below for auto-inserting date, project name, version, etc  -->
	<!-- <script type="text/javascript">
        writeFooter.call(this);
    </script> -->
    </li>
  </ul>
</div>
</body>
</html>
